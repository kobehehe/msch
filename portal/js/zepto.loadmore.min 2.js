(function(n,t){function r(i,r){this.store={element:{},options:{}};this.options=n.extend({},f,r);n.extend(!0,this.store.options,this.options);this.$element=n(i);this.$win=n(t);this.$loadingClassTarget=this._getLoadingClassTarget();this.$scrollContainer=this._getScrollContainer();this.loading=!1;this.doneLoadingInt=null;this.pageCount=this.options.triggerInitialLoad?this.options.startingPageCount-1:this.options.startingPageCount;this.destroyed=!1;this.store.element=i;this.init()}function e(t,i,r){t&&n.isFunction(t[i])&&t[i].apply(t,r)}function o(n,t,i){var r;return function(){var u=this,f=arguments,e=function(){r=null;i||n.apply(u,f)},o=i&&!r;clearTimeout(r);r=setTimeout(e,t);o&&n.apply(u,f)}}var i="loadmore",u="plugin_"+i,f={bottomBuffer:0,debounceInt:100,doneLoading:null,interval:300,loadingClass:"loading",loadingClassTarget:null,loadMoreDelay:0,loadMore:n.noop,startingPageCount:1,triggerInitialLoad:!1};r.prototype={init:function(){this._addListeners();this.options.triggerInitialLoad?this._beginLoadMore(this.options.loadMoreDelay):this._handleScroll()},_getLoadingClassTarget:function(){return this.options.loadingClassTarget?n(this.options.loadingClassTarget):this.$element},_getScrollContainer:function(){var t=null;return this.$element.css("overflow-y")=="scroll"&&(t=this.$element),t||(t=this.$element.parents().filter(function(){return n(this).css("overflow-y")=="scroll"})),t.length>0?t:this.$win},_addListeners:function(){var n=this;this.$scrollContainer.on("scroll."+i,o(function(){n._handleScroll()},this.options.debounceInt))},_removeListeners:function(){this.$scrollContainer.off("scroll."+i)},_handleScroll:function(){var n=this;this._shouldTriggerLoad()&&(this._beginLoadMore(this.options.loadMoreDelay),this.options.doneLoading&&(this.doneLoadingInt=setInterval(function(){n.options.doneLoading(n.pageCount)&&n._endLoadMore()},this.options.interval)))},_shouldTriggerLoad:function(){var n=this._getElementHeight(),t=this.$scrollContainer.scrollTop()+this.$scrollContainer.height()+this.options.bottomBuffer;return!this.loading&&t>=n&&this.$element.is(":visible")},_getElementHeight:function(){return this.$element==this.$scrollContainer?this.$element[0].scrollHeight:this.$element.height()},_beginLoadMore:function(t){t=t||0;setTimeout(n.proxy(function(){this.pageCount++;this.options.loadMore(this.pageCount,n.proxy(this._endLoadMore,this));this.$loadingClassTarget.addClass(this.options.loadingClass)},this),t);this.loading=!0;this._removeListeners()},_endLoadMore:function(){clearInterval(this.doneLoadingInt);this.loading=!1;this.$loadingClassTarget.removeClass(this.options.loadingClass);this.destroyed||this._addListeners()},destroy:function(){this._removeListeners();this.options.loadMore=null;this.options.doneLoading=null;clearInterval(this.doneLoadingInt);this.destroyed=!0},reset:function(){console.log(this.store.options);n.extend(!0,this.options,this.store.options);this.$element=n(this.store.element);this.$win=n(t);this.$loadingClassTarget=this._getLoadingClassTarget();this.$scrollContainer=this._getScrollContainer();this.loading=!1;this.doneLoadingInt=null;this.pageCount=this.options.triggerInitialLoad?this.options.startingPageCount-1:this.options.startingPageCount;this.destroyed=!1;this.init()}};n.fn[i]=function(t){var i=!1,f=arguments;return typeof t=="string"&&(i=t),this.each(function(){var o=n.data(this,u);o||i?i&&e(o,i,Array.prototype.slice.call(f,1)):n.data(this,u,new r(this,t))})};t.Loadmore=t.Loadmore||r})(Zepto,window);